import pygame
import random
import sys

# --- 初始化 Pygame ---
pygame.init()
pygame.font.init()

# --- 遊戲常數設定 ---
WIDTH, HEIGHT = 800, 600
FPS = 60

# 顏色定義 (RGB)
COLOR_BG = (15, 23, 42)        # Slate 900 深藍背景
COLOR_BASKET = (203, 213, 225) # Slate 300 籃子顏色
COLOR_TEXT = (255, 255, 255)
COLOR_SCORE = (250, 204, 21)   # Yellow 400

# 泡泡顏色
COLOR_RED = (239, 68, 68)      # 紅
COLOR_YELLOW = (234, 179, 8)   # 黃
COLOR_GREEN = (34, 197, 94)    # 綠
COLOR_BLUE = (59, 130, 246)    # 藍

# 評級背景顏色
BG_RED = (127, 29, 29)    # Red 900
BG_GREEN = (20, 83, 45)   # Green 900
BG_PURPLE = (88, 28, 135) # Purple 900

# 籃子設定
BASKET_WIDTH = 150  # 寬度 150
BASKET_HEIGHT = 20  # 平板高度
BASKET_SPEED = 6    # 移動速度 (較慢)

# --- 字型設定 ---
# 嘗試載入支援中文的系統字型
def get_chinese_font(size):
    possible_fonts = ["Microsoft JhengHei", "SimHei", "PMingLiU", "Arial Unicode MS"]
    for font_name in possible_fonts:
        try:
            return pygame.font.SysFont(font_name, size, bold=True)
        except:
            continue
    # 如果都找不到，回傳預設字型 (中文可能會變方框，但在英文系統這很常見)
    return pygame.font.SysFont("arial", size, bold=True)

font_ui = get_chinese_font(24)
font_score = get_chinese_font(40)
font_bubble = pygame.font.SysFont("arial", 16, bold=True)
font_title = get_chinese_font(60)
font_large = get_chinese_font(80)

# 設定螢幕
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("泡泡暴雨挑戰 (Bubble Rain)")
clock = pygame.time.Clock()

# --- 類別定義 ---

class Basket:
    def __init__(self):
        self.rect = pygame.Rect(WIDTH // 2 - BASKET_WIDTH // 2, HEIGHT - 60, BASKET_WIDTH, BASKET_HEIGHT)
    
    def move(self, keys):
        if keys[pygame.K_LEFT] and self.rect.left > 0:
            self.rect.x -= BASKET_SPEED
        if keys[pygame.K_RIGHT] and self.rect.right < WIDTH:
            self.rect.x += BASKET_SPEED

    def draw(self, surface):
        # 畫籃子本體
        pygame.draw.rect(surface, COLOR_BASKET, self.rect, border_radius=4)
        # 畫邊框裝飾
        pygame.draw.rect(surface, (255, 255, 255), self.rect, 2, border_radius=4)
        # 畫紋理線條 (裝飾用)
        for i in range(15, BASKET_WIDTH, 15):
            start_pos = (self.rect.x + i, self.rect.y)
            end_pos = (self.rect.x + i, self.rect.y + BASKET_HEIGHT)
            pygame.draw.line(surface, (100, 116, 139), start_pos, end_pos, 1)

class Bubble:
    def __init__(self):
        self.radius = random.randint(18, 28)
        self.x = random.randint(self.radius, WIDTH - self.radius)
        self.y = -self.radius * 2
        
        # --- 分數與顏色機率設定 ---
        chance = random.random()
        
        if chance < 0.1: # 10% 紅色 (80-100)
            self.score = random.randint(80, 100)
            self.color = COLOR_RED
        elif chance < 0.3: # 20% 黃色 (60-79)
            self.score = random.randint(60, 79)
            self.color = COLOR_YELLOW
        elif chance < 0.6: # 30% 綠色 (40-59)
            self.score = random.randint(40, 59)
            self.color = COLOR_GREEN
        else: # 40% 藍色 (20-39)
            self.score = random.randint(20, 39)
            self.color = COLOR_BLUE
            
        # 速度：分數越高稍微越快
        self.speed = random.uniform(3.0, 5.0) + (self.score / 100.0)

    def move(self):
        self.y += self.speed

    def draw(self, surface):
        # 實心圓
        pygame.draw.circle(surface, self.color, (int(self.x), int(self.y)), self.radius)
        # 白色邊框
        pygame.draw.circle(surface, (255, 255, 255), (int(self.x), int(self.y)), self.radius, 1)
        # 高光
        pygame.draw.circle(surface, (255, 255, 255, 100), (int(self.x - self.radius*0.3), int(self.y - self.radius*0.3)), 4)
        
        # 顯示分數
        text = font_bubble.render(str(self.score), True, (255, 255, 255))
        text_rect = text.get_rect(center=(self.x, self.y))
        surface.blit(text, text_rect)

    def get_rect(self):
        return pygame.Rect(self.x - self.radius, self.y - self.radius, self.radius * 2, self.radius * 2)

class Particle:
    def __init__(self, x, y, color):
        self.x = x
        self.y = y
        self.color = color
        self.size = random.randint(3, 6)
        self.vx = random.uniform(-4, 4)
        self.vy = random.uniform(-4, 4)
        self.life = 1.0 # 透明度/壽命

    def update(self):
        self.x += self.vx
        self.y += self.vy
        self.life -= 0.05
        self.size -= 0.1

    def draw(self, surface):
        if self.life > 0 and self.size > 0:
            # 建立一個支援透明度的 Surface
            s = pygame.Surface((int(self.size*2), int(self.size*2)), pygame.SRCALPHA)
            pygame.draw.circle(s, (*self.color, int(255 * self.life)), (int(self.size), int(self.size)), int(self.size))
            surface.blit(s, (self.x - self.size, self.y - self.size))

# --- 輔助函式 ---

def draw_text_centered(surface, text, font, color, center_y, bg_color=None):
    text_obj = font.render(text, True, color)
    text_rect = text_obj.get_rect(center=(WIDTH // 2, center_y))
    if bg_color:
        bg_rect = text_rect.inflate(20, 10)
        pygame.draw.rect(surface, bg_color, bg_rect, border_radius=5)
    surface.blit(text_obj, text_rect)

def reset_game():
    # 重置所有變數：籃子、泡泡列表、粒子列表、分數、時間、生成計時器
    return Basket(), [], [], 0, 60, 0

# --- 主遊戲迴圈 ---

def main():
    running = True
    game_state = "START" # 狀態: START, PLAYING, GAMEOVER
    
    basket, bubbles, particles, score, time_left, spawn_timer = reset_game()
    start_ticks = 0 # 用來記錄開始時間
    
    while running:
        # 1. 事件處理
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
            
            # 按下空白鍵或滑鼠點擊
            if event.type == pygame.MOUSEBUTTONDOWN or (event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE):
                if game_state == "START":
                    game_state = "PLAYING"
                    basket, bubbles, particles, score, time_left, spawn_timer = reset_game()
                    start_ticks = pygame.time.get_ticks()
                elif game_state == "GAMEOVER":
                    game_state = "START"

        # 2. 邏輯更新
        if game_state == "PLAYING":
            # 計算剩餘時間
            seconds_passed = (pygame.time.get_ticks() - start_ticks) / 1000
            time_left = 60 - int(seconds_passed)
            
            if time_left <= 0:
                game_state = "GAMEOVER"
                time_left = 0

            # 籃子移動
            keys = pygame.key.get_pressed()
            basket.move(keys)

            # 生成泡泡 (大量掉落邏輯)
            spawn_timer -= 1
            if spawn_timer <= 0:
                # 隨機生成 1-3 個泡泡 (模擬暴雨)
                count = 1
                if random.random() > 0.6: count = 2
                if random.random() > 0.85: count = 3
                
                for _ in range(count):
                    bubbles.append(Bubble())
                
                spawn_timer = random.randint(5, 12) # 下一次生成的間隔 (幀數)

            # 更新泡泡與碰撞
            for bubble in bubbles[:]:
                bubble.move()
                
                # 碰撞檢測 (簡易矩形碰撞，碰到籃子就算分)
                if basket.rect.colliderect(bubble.get_rect()):
                    # 接到泡泡
                    score += bubble.score
                    # 產生特效粒子
                    for _ in range(8):
                        particles.append(Particle(bubble.x, bubble.y, bubble.color))
                    bubbles.remove(bubble)
                    continue
                
                # 移除出界
                if bubble.y > HEIGHT:
                    bubbles.remove(bubble)

            # 更新粒子
            for p in particles[:]:
                p.update()
                if p.life <= 0:
                    particles.remove(p)

        # 3. 畫面繪製
        screen.fill(COLOR_BG)
        
        if game_state == "START":
            # 繪製標題畫面
            draw_text_centered(screen, "泡泡暴雨挑戰", font_title, (56, 189, 248), HEIGHT // 2 - 100)
            draw_text_centered(screen, "左右移動籃子，盡情接取泡泡！", font_ui, (200, 200, 200), HEIGHT // 2 - 20)
            
            # 說明文字
            info_y = HEIGHT // 2 + 50
            draw_text_centered(screen, "目標：11000分以上獲得「良好」評價", font_ui, (248, 113, 113), info_y)
            draw_text_centered(screen, "按 空白鍵 或 滑鼠 點擊開始", font_ui, COLOR_TEXT, HEIGHT - 100, (30, 41, 59))
            
        elif game_state == "PLAYING":
            # 繪製遊戲畫面
            basket.draw(screen)
            for bubble in bubbles:
                bubble.draw(screen)
            for p in particles:
                p.draw(screen)
            
            # 顯示分數
            score_text = font_score.render(f"{score}", True, COLOR_SCORE)
            screen.blit(score_text, (20, 20))
            
            # 顯示時間 (最後10秒變紅)
            time_color = (255, 255, 255)
            if time_left <= 10: time_color = (239, 68, 68)
            time_text = font_score.render(f"{time_left}", True, time_color)
            screen.blit(time_text, (WIDTH - 80, 20))
            
        elif game_state == "GAMEOVER":
            # 決定背景顏色和評價文字
            bg_color = BG_PURPLE
            grade_text = "待加強"
            text_color = (192, 132, 252) # 淺紫
            
            if score >= 11000:
                bg_color = BG_RED
                grade_text = "良好"
                text_color = (252, 165, 165) # 淺紅
            elif score >= 10000:
                bg_color = BG_GREEN
                grade_text = "不錯"
                text_color = (134, 239, 172) # 淺綠
            
            screen.fill(bg_color)
            
            draw_text_centered(screen, grade_text, font_large, text_color, HEIGHT // 2 - 80)
            draw_text_centered(screen, "最終分數", font_ui, (255, 255, 255), HEIGHT // 2 + 10)
            draw_text_centered(screen, str(score), font_large, (255, 255, 255), HEIGHT // 2 + 70)
            
            draw_text_centered(screen, "按 空白鍵 再玩一次", font_ui, (255, 255, 255), HEIGHT - 100, (0, 0, 0))

        pygame.display.flip()
        clock.tick(FPS)

    pygame.quit()
    sys.exit()

if __name__ == "__main__":
    main()